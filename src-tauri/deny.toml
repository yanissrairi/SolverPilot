# cargo-deny configuration - STRICT + PRAGMATIC (SOTA 2026)
# https://embarkstudios.github.io/cargo-deny/
#
# Philosophy: DENY what we control, WARN on ecosystem issues for visibility

# ============================================================================
# Graph - Target platforms
# ============================================================================
[graph]
targets = [
    "x86_64-unknown-linux-gnu",
    "aarch64-unknown-linux-gnu",
    "x86_64-apple-darwin",
    "aarch64-apple-darwin",
    "x86_64-pc-windows-msvc",
]
all-features = true

# ============================================================================
# Output
# ============================================================================
[output]
feature-depth = 1

# ============================================================================
# Advisories - Security vulnerabilities (RustSec)
# ============================================================================
[advisories]
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]
# STRICT: Only fail on direct dependencies, but SHOW all warnings
unmaintained = "workspace"
# Ignored advisories (with justification)
ignore = [
    # glib 0.18.5 unsoundness - GTK3 bindings unmaintained, no fix possible
    # Severity: INFO (unsound, not exploitable remotely)
    # https://github.com/tauri-apps/tauri/issues/12048
    # Waiting for Tauri GTK4 migration (no ETA)
    { id = "RUSTSEC-2024-0429", reason = "upstream GTK3 bindings unmaintained, wontfix" },

    # Marvin Attack (RSA timing sidechannel) in rsa 0.9/0.10
    # Affects: russh dependency chain
    # Severity: MEDIUM (timing attack requires network observation)
    # Mitigation: Local usage only, no remote exposure of timing info
    # Status: No patch available upstream, tracking https://github.com/RustCrypto/RSA/issues/19
    # Safe in our context: SSH client for local workstation use
    { id = "RUSTSEC-2023-0071", reason = "local usage only, no network timing exposure" },
]

# ============================================================================
# Bans - Dependency restrictions
# ============================================================================
[bans]
# PRAGMATIC: warn (not deny) - duplicates are ecosystem-wide, not our fault
# This is the official recommended default
# We still SEE all duplicates, but CI doesn't fail on unavoidable issues
multiple-versions = "warn"

# STRICT: Never allow wildcard dependencies
wildcards = "deny"

# Show all duplicate info in output
highlight = "all"

# STRICT: Banned crates with pure-Rust alternatives
deny = [
    # Prefer rustls over OpenSSL (pure Rust, no C dependencies)
    { crate = "openssl", use-instead = "rustls" },
    { crate = "openssl-sys", use-instead = "rustls" },
    # Prefer gix over libgit2 (pure Rust)
    { crate = "git2", use-instead = "gix" },
    { crate = "libgit2-sys", use-instead = "gix" },
]

# STRICT: No skip - we want to SEE all duplicates as warnings
# Note: cmake is a build dependency (aws-lc-sys) but not banned, so no skip needed
skip = []
skip-tree = []

# ============================================================================
# Licenses - Permissive only + MPL-2.0 (required by Tauri)
# ============================================================================
[licenses]
# High confidence for license detection
confidence-threshold = 0.93
# Don't warn on unused licenses in allow list
unused-allowed-license = "allow"

# Allowed licenses (permissive + weak copyleft for Tauri)
allow = [
    # Permissive
    "MIT",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Zlib",
    "0BSD",
    "Unlicense",
    "CC0-1.0",
    "BSL-1.0",
    # OpenSSL license (permissive, FSF Free/Libre)
    # Required by: aws-lc-sys (russh crypto backend)
    "OpenSSL",
    # Unicode (common in text processing)
    "Unicode-3.0",
    "Unicode-DFS-2016",
    # Weak copyleft - REQUIRED by Tauri (cssparser, selectors, etc.)
    "MPL-2.0",
]

# No exceptions needed
exceptions = []

# Clarify ring's complex license
[[licenses.clarify]]
name = "ring-3"
expression = "MIT AND ISC AND OpenSSL"
license-files = [{ path = "LICENSE", hash = 0xbd0eed23 }]

# ============================================================================
# Sources - STRICT: Only crates.io
# ============================================================================
[sources]
# STRICT: Deny unknown registries
unknown-registry = "deny"
# STRICT: Deny unknown git sources
unknown-git = "deny"
# Only allow official crates.io
allow-registry = ["https://github.com/rust-lang/crates.io-index"]
# No git sources allowed
allow-git = []
